# Fix Escalier Internal vs External Video Flows

**Date**: 2025-12-10  
**Statut**: ✅ Implémenté  
**Priorité**: Haute

---

## Problème

Erreur Veo: `"Input video must be a video that was generated by VEO"`

Les extensions internes (Veo → Veo) étaient incorrectement détectées comme extensions externes, causant un switch vers `TEXT_TO_VIDEO` mode au lieu de `EXTEND_VIDEO`.

---

## Cause Racine

`handleStartExtensionAssistant()` définissait `originalVideoForExtension` pour **toutes** les extensions (internes ET externes).

La condition de détection utilisait `originalVideoForExtension?.file` ce qui déclenchait la logique externe même pour les extensions internes.

---

## Solution Implémentée

Ajout d'un flag explicite `isExternalVideoSource` :

**Fichier modifié**: `Studio.tsx`

### 1. Nouveau State

```typescript
// Ligne 298
const [isExternalVideoSource, setIsExternalVideoSource] = useState(false);
```

### 2. Detection Modifiée

```typescript
// Ligne 568 - Avant
if (
  effectiveParams.mode === GenerationMode.EXTEND_VIDEO &&
  originalVideoForExtension?.file &&
  !effectiveParams.inputVideoObject?.uri
)

// Après
if (
  effectiveParams.mode === GenerationMode.EXTEND_VIDEO &&
  isExternalVideoSource &&  // ← Flag explicite
  originalVideoForExtension?.file
)
```

### 3. Flag Actions

| Handler | Flag | Mode Résultant |
|---------|------|----------------|
| `handleStartExternalExtensionAssistant` | `true` | TEXT_TO_VIDEO + startFrame |
| `handleStartExtensionAssistant` | `false` | EXTEND_VIDEO + URI Veo |

---

## Flux Corrigé

### Extension Interne (Veo → Veo)
```
handleStartExtensionAssistant
  → setIsExternalVideoSource(false)
  → handleGenerate
    → isExternalVideoSource = false
    → Mode: EXTEND_VIDEO
    → inputVideoObject: { uri: "veo://..." }
```

### Extension Externe (Upload → Veo)
```
handleStartExternalExtensionAssistant
  → setIsExternalVideoSource(true)
  → handleGenerate
    → isExternalVideoSource = true
    → Mode: TEXT_TO_VIDEO
    → startFrame: lastFrame
```

---

## Fichiers Modifiés

| Fichier | Lignes | Changement |
|---------|--------|------------|
| `Studio.tsx` | 298 | Ajout state `isExternalVideoSource` |
| `Studio.tsx` | 568-576 | Condition de détection modifiée |
| `Studio.tsx` | 1065 | Reset flag dans `handleStartExtensionAssistant` |
| `Studio.tsx` | 1079 | Set `true` dans `handleStartExternalExtensionAssistant` |
| `Studio.tsx` | 610 | Reset flag après génération |
